#!/usr/bin/env bash
# Convertit un fichier markdown en un fichier PDF via pandoc
# Copyright (C) 2016-2020 Bruno BEAUFILS
#
# usage: md2pdf [OPTIONS] SOURCE [FICHIERS-INCLUS...]
#
# md2pdf est un wrapper autour de pandoc qui permet de convertir un fichier au
# format Markdown vers un format PDF en diaporama (via LaTeX et Beamer) ou en
# rapport (via LaTeX).
#
# SOURCE est le fichier au format Markdown. Il doit avoir comme suffixe
# '.md'. Le fichier PDF est généré dans le répertoire courant.
#
# OPTIONS
#
#     -h, --help               affiche ce message d'aide
#         --man                affiche la documentation
#     -r, --report             produit un rapport
#     -p, --presentation       produit une présentation
#     -e, --examples DIR       produit des fichiers exemples dans DIR
#     -c, --check              vérifie la présence des outils nécessaires
#     -l, --list-debian        liste les paquets Debian nécessaires
#     -t, --theme THEME        utilise THEME (au lieu de 'ulille') comme
#                              personnalisation. THEME vide ou égal à 'list'
#                              affiche ceux embarqués dans le script.
#     -s, --slide-level N      utilise le niveau N (au lieu de 2) pour les diapos
#     -D, --debug              conserve le répertoire de travail (/tmp/md2pdf)
#     -L, --latex              produit le source LaTeX (au lieu du résultat PDF)
#     -P, --pandoc-extra ARGS  ajoute ARGS à la ligne de commande pandoc
#     -W, --workdir DIR        utilise DIR (au lieu de /tmp/md2pdf) comme
#                              répertoire de travail
#     -V, --version            affiche la version du script
#
# DESCRIPTION
#
#     Si le document utilise d'autres fichiers que le source Markdown
#     on doit les spécifier à la suite de son chemin. On peut, par
#     exemple, spécifier individuellement des fichiers images, des
#     modèles remplaçants ceux utilisés par le script (modèle pandoc,
#     thème beamer, paquet LaTeX, etc.) ou des répertoires complets.
#
#     Les formats d'images pris en charge sont pdf (pour du vectoriel)
#     et png ou jpg (pour du matriciel). Les images incluses dans
#     SOURCE avec un nom suffixé par '.svg' sont automatiquement
#     recherchées avec l'extension '.pdf' à la place. La conversion
#     des fichiers eux-mêmes doit avoir été faite auparavant. Elles
#     peuvent être centrées sur la largeur de page si elles ont la
#     classe '.center'.
#
#     SOURCE peut inclure d'autres fichiers markdown grâce au filtre
#     [include-files] et peut inclure du code depuis des fichiers
#     externes grâce au filtre [include-code-files].
#
#     [include-files]: https://github.com/pandoc/lua-filters/tree/master/include-files
#     [include-code-files]: https://github.com/pandoc/lua-filters/tree/master/include-code-files
#
# PRÉSENTATIONS/DIAPORAMAS
#
#     Pour une transformation en présentation, les diapositives sont les
#     sections de niveau 2, avec le titre de la section comme titre de
#     diapositive. On peut changer le niveau via l'option '--slide-level'.
#
# EXEMPLES
#
#     Vérifier que les outils nécessaires sont disponibles sur la machine :
#     
#         md2pdf -c
#     
#     Convertir le fichier presentation.md qui inclut l'image image.pdf en
#     diaporama :
#     
#         md2pdf -p presentation.md image.pdf
#     
#     Convertir le fichier diapos.md qui inclut des images du répertoire img
#     en diaporama :
#     
#         md2pdf -p diapos.md img/image1.pdf img/image2.png
#     
#     Convertir le fichier diapos.md qui inclut des images du répertoire img
#     en diaporama
#     
#         md2pdf diapos.md img
#
# DEPENDANCES
#
#     Pour fonctionner md2pdf a besoin que 'pandoc' ainsi qu'une
#     installation TeX (avec 'pdflatex' et la classe 'beamer.cls')
#     soit accessible. Seule la distribution TeXLive disponible pour
#     Unix et Windows (sous le nom MacTeX pour Mac OS X) a été testée.
#
#     [pandoc]: http://pandoc.org
#     [texlive]: http://tug.org/texlive
#     [mactex]: http://tug.org/mactex
#
# LIMITATIONS
#
#     Avec les dépendances spécifiées, en l'état ce script ne peut pas
#     fonctionner complètement sous MacOS X car il utilise des options
#     spécifiques aux versions GNU des commandes UNIX classiques.
#
# DETAILS D'IMPLEMENTATION
# ========================
#
# FILTRES
# -------
#
#     Toutes les transformations sont exécutés dans un répertoire de travail
#     (par défaut '/tmp/md2pdf') pour ne pas modifier le fichier source
#     original. Ce répertoire est supprimé (sauf si l'option '--debug' est
#     utilisée) après la production du fichier PDF.
#
#     Des filtres pandoc [lua] sont utilisés pour la conversion. Ils
#     étendent le comportement de base de pandoc :
#
#     - [include-files]
#     - [include-code-files]
#     - center-image
#     - svg-image-to-pdf
#
#     [lua]: https://pandoc.org/lua-filters.html
#
# TEMPLATES
# ---------
#
#     Des [templates] pandoc spécifiques sont utilisés pour les
#     transformations. Ils définissent la composition du document
#     généré :
#
#     - 'beamer-pandoc.tex' pour les diaporamas. Il importe un thème
#       Beamer via la commande LaTeX '\usetheme'.
#
#     - 'report-pandoc.tex' pour les rapports. Il incorpore un paquet
#       LaTeX 'reportthemeTHEME' via la commande '\usepackage'.
#
#     Ils utilisent des variables, par exemple, pour la génération de
#     la page de titre, par exemple. Les variables peuvent être
#     spécifiées dans un bloc YAML dans SOURCE.
#
#     [templates]: https://pandoc.org/MANUAL.html#templates
#
# FICHIERS EMBARQUES
# ------------------
#
#     Des fichiers nécessaires autres que les sources (modèles pandoc, thèmes
#     beamer, logos, exemples) sont embarqués en fin de script (pour pouvoir
#     diffuser le script et rien d'autre). L'embarquement est fait entre deux
#     lignes sous la forme :
#
#         # begin-THEMES FILENAME [ENCODAGE]
#         ...
#         # end FILENAME
#
#     THEMES correspond à une liste de thème pour lesquels le fichier est
#     nécessaire et doit donc être extrait avant la conversion. Dans cette
#     liste les thèmes sont séparés les uns des autres par un tiret (-). Si
#     THEMES vaut juste 'all' le fichier est extrait pour tous les thèmes.
#
#     ENCODAGE peut être base64. Quand il est absent la commande à utiliser
#     pour reconstruire le fichier est juste 'cat' (quand le contenu est
#     textuel et qu'il faut juste l'extraire). Quand il vaut base64 (quand le
#     contenu du fichier est binaire et qu'on l'a embarqué en base64) on
#     utilise 'base64 -d'.
#
#     L'inclusion des fichiers est compatible (listage, extraction, etc.) avec
#     ma commande shembed.
#
#     [shembed]: https://github.com/b3/util-shembed
#
#  

# TODO: lister et documenter les variables de chaque template
# TODO: transformer la documentation en markdown (pour exporter en HTML, PDF, man)
# TODO: ajouter un mode article
# TODO: expliciter extensions markdown supportées
# TODO: documenter nom des modèles pandoc et LaTeX utilisé
# TODO: documenter extension YAML et titleimg
# TODO: permettre extensions (pandoc ou perso) via des commentaires HTML (particuliers)
# TODO: inclure modele-diaporama.md et permettre son extraction
# TODO: permettre le changement du répertoire temporaire

# CONVENTIONS DE CODAGE
#
# Quand on ajoute/modifie quelque chose il faut penser à un fonctionnement
# sous Linux **et** BSD (e.g. MacOS X). Il faut par exemple être
# précautionneux avec les options de commandes Unix classiques qui sont
# souvent différentes. Dans l'idéal il faudrait penser POSIX.

# Un sed POSIX pour être portable (au moins Linux, FreeBSD et MacOS X)
gnu=$(sed v </dev/null >/dev/null 2>&1 && echo " --posix") # 'v' est spécifique à GNU sed
_sed () { sed $gnu -E "$@" ; }

err_p="${0##*/}: error:"

doc () { _sed -n '2,/^ *##$/ { s/^ *#([^#]|$)// ; s/^ //g ; t ok ; d ; :ok ; p }' <$0 ; }
docx ()  { _sed -n '2,/^$/ { s/^ *#([^#]|$)// ; s/^ //g ; t ok ; d ; :ok ; p }' <$0 | pager ; }
die () { echo "$err_p $*" 1>&2 ; exit 1 ; }
abs () { echo $(cd $(dirname -- $1) ; pwd)/${1##*/} ; }
isopt () { [[ x$1 =~ x-.* ]] ; }
mute () { 1>/dev/null 2>&1 $* ; }
need () { die "$1 is unavailable" ; }
debug () { sed 's/^/DEBUG: /' <<<"$*" 2>& 1; }

# réussit si les outils nécessaires sont accessibles
check ()
{
    mute which pandoc || need pandoc
	mute which make || need make
    mute which tar || need tar
    mute which base64 || need base64 coreutils
    mute which pdflatex || need pdflatex texlive-latex-base
    mute kpsewhich beamer.cls || need beamer.cls texlive-latex-recommended
}

# extrait un fichier embarqué dans le script
# args: dstdir theme name [encodage]
extract_file ()
{
    d=$1
    t=$2
    f=$3
    shift 3
    e=cat && [ "x$1" = xbase64 ] && e="base64 -d"
    _sed -n '/^# begin((-[^ ]+)*(-'$t')(-[^ ]+)*|-all) '$f'($| .*$)/,/^# end '$f'$/ p' -- $cmd \
        | sed '1d ; $d' \
        | $e >$d/$f
}

# liste les fichiers pour un thème donné (avec leur encodage)
# args: theme
list_files ()
{
    grep '^# begin-' -- $cmd \
        | grep -e "-$1[- ]" -e '# begin-all '\
        | _sed -e 's/^# begin-[^ ]+ (.*)$/\1/'
}

# liste les thèmes qui embarque des fichiers dans le script
list_themes ()
{
    grep '^# begin-' -- $cmd \
        | _sed -e 's/^# begin-([^ ]+) .*$/\1/' \
        | tr '-' '\n' | sort | uniq
}

# extrait les exemples
# args: dst
extrait_exemples ()
{
    mkdir -p "$1/img"
    list_files examples | while read f
    do
        d="$1"
        [[ x$f =~ x*.pdf ]] && d="$1/img"
        extract_file "$d" examples $f
    done
    extract_file "$1/img" ulille logo-univ-lille.pdf base64
}

##############################################################################

VERSION=2.1.20201116-1

TYPE=none

DEBUG=false
LATEX_ONLY=false

DESTDIR=$PWD
TMPDIR=/tmp/md2pdf

# type en fonction du nom du script
[ ${0##*/} = "md2beamer" ] && TYPE=beamer
[ ${0##*/} = "md2report" ] && TYPE=report

cmd=$(abs $0)

# gestion des options et arguments

while isopt $1
do
    case "$1" in
        "-h"|"--help")
            doc && exit 0
            ;;
        "--man")
            docx && exit 0
            ;;
        "-p"|"--presentation")
            TYPE=beamer
            ;;
        "-r"|"--report")
            TYPE=report
            ;;
        "-e"|"--examples")
            shift
            extrait_exemples "$1"
            exit 0
            ;;
        "-c"|"--check")
            check && exit 0
            ;;
        "-l"|"--list-debian")
            _sed -n '/\|\| need/ { s/^.* (.*)$/\1/ ; p }' -- $0
            exit
            ;;
        "-t"|"--theme")
            shift
            if [ -z "$1" ] || isopt "$1" || [ "$1" = "list" ] ; then
                list_themes && exit 0
            else
                THEME=$1
            fi
            ;;
        "-s"|"--slide-level")
            shift
            SLIDELEVEL=$1
            ;;
        "-D"|"--debug")
            DEBUG=true
            ;;
        "-L"|"--latex")
            LATEX_ONLY=true
            ;;
        "-P"|"--pandoc-extra")
            shift
            PANDOC_EXTRA="$PANDOC_EXTRA $1"
            ;;
        "-W"|"--workdir")
            shift
            TMPDIR="$1"
            ;;
        "-V"|"--version")
            echo $VERSION && exit 0
            ;;
        "--")
            shift
            break ;;
        *)
            die "unknown option: $1"
            ;;
    esac
    shift
done

# vérifications de bases
check || die "some needed tools missing"
[ -z "$1" ] && die "no source file specified"
[ "$TYPE" = none ] && die "no transformation type specified"

# fichiers générés
SRC=$(abs $1)
dstmd=$(basename -- $1)
dsttex=$(basename -- $1 .md).tex
dstpdf=$(basename -- $1 .md).pdf
dstlog=$(basename -- $1 .md).log
shift

# répertoire de travail
[ -d "$TMPDIR" ] || mkdir -p "$TMPDIR"

# fichiers nécessaires au thème
list_files $THEME | while read f
do
    extract_file "$TMPDIR" $THEME $f
done

# fichiers sources et images
[ $# -ne 0 ] && { tar -chf - "$@" | tar -C "$TMPDIR" -xf - ; }

# transformation en LaTeX de base
case "$TYPE" in
    "beamer")
		test -z "$SLIDELEVEL" || PANDOC_ARGS="SLIDELEVEL=$SLIDELEVEL"
        ;;
    "report")
        ;;
    *)
        die "unknown transformation type: $TYPE"
        ;;
esac
test -z "$THEME" || PANDOC_ARGS="$PANDOC_ARGS THEME=$THEME"
cd $TMPDIR
make $PANDOC_ARGS EXTRAS="$PANDOC_EXTRA" FILE="$dsttex" $TYPE

# compilation LaTeX (ou pas)
if ! $LATEX_ONLY ; then
    trap "grep Error *.log | sed 's!^!$err_p $PWD/$dstlog: !' 2>&1  ; 
          die '$PWD/$dsttex: compilation failure ($PWD dir has been kept)'" ERR
    export TEXINPUTS=.//:
    export max_print_line=10000
    mute pdflatex -shell-escape -halt-on-error -file-line-error -- "$dsttex"
    mute pdflatex -shell-escape -halt-on-error -file-line-error -- "$dsttex"

    mv -- "$dstpdf" "$DESTDIR"
else
    mv -- "$dsttex" "$DESTDIR"
fi

$DEBUG || { cd .. ; rm -rf "$TMPDIR" ; }

##############################################################################

exit 0

##############################################################################

# begin-all beamer-pandoc.tex
\documentclass[10pt,t]{beamer}

% Paquets LaTeX %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Une gestion correcte du français (en entrée et en sortie)
\usepackage[french]{babel}
\usepackage{type1ec}         % devant fontenc (cf type1ec.sty)
\usepackage[T1]{fontenc}     % devant inputenc (utf8 choisi en fonction de ça)
\usepackage[utf8]{inputenc}
\DeclareUnicodeCharacter{20AC}{\euro} % pour la saisie du caractère euro

%% Des "jolies" polices de caractères
\usepackage{lmodern}            % pour sf et tt
\usepackage{fourier}            % pour rm
\usepackage{bbm}                % pour les mathbbm

%% Plein de symboles
\usepackage{amssymb}            % Les symboles mathématiques de l'AMS
\usepackage{latexsym}           % Quelques symboles manquants dans LaTeX 2e
\usepackage{marvosym}           % Quelques symboles en vrac par Martin Vogel
\usepackage{wasysym}            % Quelques symboles en vrac par Roland Waldi
\usepackage{pifont}             % Les symboles Dingbats
\usepackage{textcomp}           % \textcopyleft
\usepackage[copyright]{ccicons} % Les (c) comme dans Creative Commons
\usepackage[official,right]{eurosym} % L'euro

%% Quelques paquets utiles
\usepackage{array}              % pour faciliter les styles de tableaux
\usepackage{longtable,booktabs} % pour les longues tables générées par pandoc
\usepackage{relsize}            % pour faciliter le changement de taille des polices
\usepackage[normalem]{ulem}     % pour avoir des soulignements funky
\usepackage{tikz}               % pour les dessins portables
\usepackage{pgfpages}           % pour les présentations en double-écran
\usepackage{fixltx2e}           % provides \textsubscript
\usepackage{graphicx,grffile}   % pour les images
\usepackage{fancyvrb}
\usepackage{minted}             % pour les programmes

% Configuration pandoc %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Images management
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
$if(graphics)$
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight0.8\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
$endif$

%% Syntax highlighting
$if(highlighting-macros)$
$highlighting-macros$
$endif$

%% Generated lists
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

%% Prevent overfull lines
\setlength{\emergencystretch}{3em}  

% Paramétrages Beamer %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

$if(theme)$\usetheme{$theme$}$endif$

%% Image de fond pour la page de titre
\newcommand{\titleimg}[1]{\def\inserttitleimg{#1}}

% Méta-données du document %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

$if(title)$
\title{$title$}
$endif$
$if(subtitle)$
\subtitle{$subtitle$}
$endif$
$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$
$if(logo)$
\titlegraphic{%
  \rule{2em}{0cm}%
$for(logo)$
$if(logo.width)$
  \includegraphics[width=$logo.width$\columnwidth]{$logo.file$}%
$else$
  \includegraphics[width=.1\columnwidth]{$logo.file$}%
$endif$
  \rule{2em}{0cm}$if(logo.nl)$\par\medskip\rule{2em}{0cm}$endif$%
$endfor$
}
$endif$
$if(img)$
\titleimg{$img$}
$endif$
\date{$date$}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\begin{frame}[plain]
  \titlepage
\end{frame}

\begin{frame}
  \frametitle{Plan}
  \tableofcontents % il faut compiler deux fois pour mettre à jour la TDM
\end{frame}

$body$

\end{document}
# end beamer-pandoc.tex

##############################################################################

# begin-all report-pandoc.tex
\documentclass[10pt,twoside,openright]{report}

% Paquets LaTeX %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Une gestion correcte du français (en entrée et en sortie)
\usepackage[french]{babel}
\usepackage{type1ec}         % devant fontenc (cf type1ec.sty)
\usepackage[T1]{fontenc}     % devant inputenc (utf8 choisi en fonction de ça)
\usepackage[utf8]{inputenc}
\DeclareUnicodeCharacter{20AC}{\euro} % pour la saisie du caractère euro

%% Des "jolies" polices de caractères
\usepackage{lmodern}            % pour sf et tt
\usepackage{fourier}            % pour rm
\usepackage{bbm}                % pour les mathbbm

%% Plein de symboles
\usepackage{amssymb,amsmath}    % Les symboles mathématiques de l'AMS
\usepackage{latexsym}           % Quelques symboles manquants dans LaTeX 2e
\usepackage{marvosym}           % Quelques symboles en vrac par Martin Vogel
\usepackage{wasysym}            % Quelques symboles en vrac par Roland Waldi
\usepackage{pifont}             % Les symboles Dingbats
\usepackage{textcomp}           % \textcopyleft
\usepackage[copyright]{ccicons} % Les (c) comme dans Creative Commons
\usepackage[official,right]{eurosym} % L'euro

%% Mise en page
\usepackage{geometry}

%% Quelques paquets utiles
\usepackage{array}              % pour faciliter les styles de tableaux
\usepackage{longtable,booktabs} % pour les longues tables générées par pandoc
\usepackage{relsize}            % pour le changement de taille des polices
\usepackage[normalem]{ulem}     % pour avoir des soulignements funky
\usepackage{tikz}               % pour les dessins portables
\usepackage{fixltx2e}           % provides \textsubscript
\usepackage{graphicx,grffile}   % pour les images
\usepackage{fancyvrb}
\usepackage{minted}             % pour les programmes
\usepackage{hyperref}           % le plus tard possible d'après la doc

% Configuration pandoc %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Images management
% Scale images if necessary so that they will not overflow the page margins by
% default, and it is still possible to overwrite the defaults using explicit
% options in \includegraphics[width, height, ...]{}
$if(graphics)$
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight0.8\textheight\else\Gin@nat@height\fi}
\makeatother
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
$endif$

%% Syntax highlighting
$if(highlighting-macros)$
$highlighting-macros$
$endif$

%% Generated lists
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}

%% Redefines (sub)paragraphs to behave more like sections
\ifx\paragraph\undefined\else
\let\oldparagraph\paragraph
\renewcommand{\paragraph}[1]{\oldparagraph{#1}\mbox{}}
\fi
\ifx\subparagraph\undefined\else
\let\oldsubparagraph\subparagraph
\renewcommand{\subparagraph}[1]{\oldsubparagraph{#1}\mbox{}}
\fi

%% Prevent overfull lines
\setlength{\emergencystretch}{3em}

% Adaptation LaTeX %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\makeatletter
\newcommand{\subtitle}[1]{\gdef\insertsubtitle{#1}}
\newcommand{\titlelogo}[1]{\def\inserttitlelogo{#1}}
\newcommand{\titleimg}[1]{\def\inserttitleimg{#1}}
\renewcommand{\and}{%
  \end{tabular}%
  \par%
  \begin{tabular}[t]{c}%
}
\renewcommand{\maketitle}{\begin{titlepage}%
$if(title-image)$
  \tikz[remember picture,overlay]
    \node[opacity=0.2,inner sep=0pt] at (current page.center){%
      \includegraphics[width=\paperwidth,height=\paperheight]{\inserttitleimg}%
    };%
$endif$
  % Titre & Date
  \tikz[remember picture,overlay]
    \node[yshift=-6cm,inner sep=0pt] at (current page.north){%
      \begin{minipage}{.99\columnwidth}
        \centering%
        {\larger[4]\bfseries \@title}\par%
        \@ifundefined{insertsubtitle}{}{%
        \bigskip%
        {\larger[3]\color[gray]{.3}\slshape \insertsubtitle}\par}%
        \@ifundefined{@date}{}{%
        \bigskip%
        {\larger[3] \@date \par}}%
      \end{minipage}
    };%
  % Auteurs
  \tikz[remember picture,overlay]
    \node[yshift=-6cm,inner sep=0pt] at (current page.center){%
      \begin{minipage}{.9\columnwidth}
        \centering\larger[2]
        \begin{tabular}[t]{c}%
          \@author
        \end{tabular}%
      \end{minipage}
    };%
  % Logos
  \@ifundefined{inserttitlelogo}{}{%
  \tikz[remember picture,overlay]
    \node[yshift=3cm,inner sep=0pt] at (current page.south){%
      \begin{minipage}{.99\columnwidth}
        \centering\larger[2]\inserttitlelogo
      \end{minipage}
    };%
   }
\end{titlepage}
}
\makeatother

% Configuration document %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\frenchbsetup{%
  ItemLabels=\textendash,%
  og=«,%
  fg=»}
\geometry{%
  a4paper,
  top=1cm,bottom=2cm,
  left=1.5cm,right=1cm}
\hypersetup{%
  $if(title-meta)$
  pdftitle={$title-meta$},
  $endif$
  $if(author-meta)$
  pdfauthor={$author-meta$},
  $endif$
  $if(keywords)$
  pdfkeywords={$for(keywords)$$keywords$$sep$; $endfor$},
  $endif$
  hyperfootnotes=false,
  colorlinks,
  urlcolor=blue,
  linkcolor=,
  pdfstartview=Fit}
\setlength{\parindent}{0pt}
\setlength{\parskip}{6pt plus 2pt minus 1pt}
$if(theme)$\usepackage{reporttheme$theme$}$endif$

$for(header-includes)$
$header-includes$
$endfor$

% Méta-données du document %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

$if(title)$
\title{$title$}
$endif$
$if(subtitle)$
\subtitle{$subtitle$}
$endif$
$if(author)$
\author{$for(author)$$author$$sep$ \and $endfor$}
$endif$
$if(logo)$
\titlelogo{%
  \rule{4em}{0cm}%
$for(logo)$
$if(logo.width)$
  \begin{minipage}[c]{$logo.width$\textwidth}
$else$
  \begin{minipage}[c]{.1\textwidth}
$endif$
    \includegraphics[width=\textwidth]{$logo.file$}%
  \end{minipage}
  \rule{4em}{0cm}$if(logo.nl)$\par\bigskip\rule{4em}{0cm}$endif$%
$endfor$
}
$endif$
$if(title-image)$
\titleimg{$title-image$}
$endif$
\date{$date$}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

$for(include-before)$
$include-before$
$endfor$

\maketitle

\tableofcontents

$body$

$for(include-after)$
$include-after$
$endfor$

\end{document}
# end report-pandoc.tex

##############################################################################

# begin-ulille beamerthemeulille.sty
% Un thème Beamer pour l'Université de Lille
% Copyright (C) 2018-2019 Bruno BEAUFILS
% This file is distributed under the terms of the WTFPL license.

\def\filedate{2019/06/20}

% Paramétrages génériques %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Les couleurs de l'Université de Lille 1
\definecolor{Lille1Pourpre}{RGB}{174,37,115}      % en HTML : ae2573
\definecolor{Lille1NeutreNoir}{RGB}{56,47,45}     % en HTML : 382f2d
\definecolor{Lille1NeutreBleu}{RGB}{127,160,172}  % en HTML : 7fa0ac
\definecolor{Lille1NeutreRose}{RGB}{216,200,209}  % en HTML : d8c8d1
\definecolor{Lille1FroideBleu}{RGB}{29,66,138}    % en HTML : 1d428a
\definecolor{Lille1FroideVert}{RGB}{0,179,152}    % en HTML : 00b398
\definecolor{Lille1FroideCyan}{RGB}{141,200,232}  % en HTML : 8dc8e8
\definecolor{Lille1ChaudeViolet}{RGB}{114,0,98}   % en HTML : 720062
\definecolor{Lille1ChaudeMarron}{RGB}{211,130,53} % en HTML : d38235
\definecolor{Lille1ChaudeTaupe}{RGB}{213,203,159} % en HTML : d5cb9f
\definecolor{Lille1ViveRouge}{RGB}{249,66,58}     % en HTML : f9423a
\definecolor{Lille1ViveVert}{RGB}{120,190,32}     % en HTML : 78be20
\definecolor{Lille1ViveJaune}{RGB}{252,227,0}     % en HTML : fce300

%% Des "jolies" polices de caractères
\usepackage{lmodern}            % pour sf et tt
\usepackage{fourier}            % pour rm
\usepackage{bbm}                % pour les mathbbm

%% La police Lille 1 n'est pas libre (Verdana) on prend le truc le plus proche
\usepackage[scaled=.92]{helvet}

%% Paramétrage hyperref
\hypersetup{%
  colorlinks,%
  linkcolor=,%
  urlcolor=Lille1Pourpre}
  
% Paramétrage Beamer %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\mode<presentation>             % pour le mode présentation seulement

%% Logos
\titlegraphic{%
  \raisebox{-0.5\height}{\includegraphics[width=6em]{logo-univ-lille}}
}
\logo{\includegraphics[height=1.5em]{logo-univ-lille}}

%% Couleurs
\usecolortheme{spruce}
\setbeamercolor{normal text}{fg=Lille1NeutreNoir}
\setbeamercolor{structure}{fg=black}
\setbeamercolor{frametitle}{fg=white,bg=Lille1Pourpre}
\setbeamercolor{title}{fg=Lille1Pourpre,bg=}
\setbeamercolor{subtitle}{fg=Lille1NeutreBleu}
\setbeamercolor{footline}{fg=white,bg=Lille1Pourpre}
\setbeamercolor{block title}{fg=white,bg=Lille1Pourpre}
\setbeamercolor{block body}{fg=Lille1NeutreNoir,bg=Lille1NeutreRose}
\setbeamercolor{block title example}{fg=white,bg=Lille1NeutreBleu}
\setbeamercolor{block body example}{fg=Lille1NeutreNoir,bg=Lille1NeutreRose}
\setbeamercolor{alerted text}{fg=Lille1Pourpre}

%% Polices de caractères
%\usefonttheme[stillsansseriflarge]{serif}
\usefonttheme[onlylarge]{structurebold}
\setbeamerfont{date in head/foot}{series=\bfseries}
\setbeamerfont{date}{series=\bfseries}
\setbeamerfont{alerted text}{series=\bfseries}

%% Traduction en français
\uselanguage{french}
\languagepath{french}
\deftranslation[to=french]{Definition}{Définition}
\deftranslation[to=french]{Example}{Exemple}
\deftranslation[to=french]{Theorem}{Théorème}

%% Adaptation des modèles

%%% La page de titre
\renewcommand{\maketitle}[1][]{%
  \addtocounter{framenumber}{-1}\frame[plain,#1]{\titlepage}}

%%% Sections dans la table des matières
\setbeamertemplate{sections/subsections in toc}[sections numbered]

%%% Une page en début de chaque cours
\newif\ifnewlecture\newlecturetrue
\AtBeginLecture{%
  \ifbeamer@inlecture
  \ifnewlecture
  \begin{frame}
    \begin{centering}
      \begin{beamercolorbox}[sep=16pt,center]{part title}
        \usebeamerfont{part title}\insertlecture
      \end{beamercolorbox}
    \end{centering}
  \end{frame}
  \newlecturefalse
  \fi
  \fi
}

%%% Une page simple devant chaque partie
\AtBeginPart{\frame{\partpage}}
\setbeamertemplate{part page}{%
  \begin{center}
    \usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}\insertpart
  \end{center}
}

%%% Une page simple (avec table des matières) devant chaque section
\setbeamertemplate{section page}{\tableofcontents[currentsection]}
\AtBeginSection[]{\frame{\sectionpage}}

%%% Une page simple (avec table des matières) devant chaque sous-section
\setbeamertemplate{subsection page}{\tableofcontents[currentsubsection]}
\AtBeginSubsection[]{\frame{\subsectionpage}}

%%% Styles des blocs
\setbeamertemplate{blocks}[rounded][shadow=true]
\setbeamerfont{block title}{size={}}

%%% Style des listes
\setbeamertemplate{items}[triangle]

%%% Type des continuations
\setbeamertemplate{frametitle continuation}[from second][(suite)]

%%% Des pieds de diapo simples
\setbeamertemplate{footline}
{
  \leavevmode%
  \hbox{%
    \begin{beamercolorbox}[wd=\paperwidth,ht=2.25ex,dp=1ex]{footline}
      \usebeamerfont{date in head/foot}
      \hspace*{1.25ex}
      \inserttitle{} \hspace*{3ex} \emph{\textmd{\insertsection}}
      \hfill
      \insertframenumber{} / \inserttotalframenumber
      \hspace*{1.25ex}
      \llap{\raisebox{2em}{\insertlogo}\hspace{.75ex}}
    \end{beamercolorbox}}%
  \vskip0pt%
}
\setbeamertemplate{navigation symbols}{} % pas de navigation affichée
\setbeamertemplate{sidebar right}{}      % pas de logo

%% D'autres paramètres Beamer en vrac

%%% On découvre lentement les trucs cachés
\setbeamercovered{dynamic}      

%%% Marges
\setbeamersize{text margin left=1em,text margin right=1em}

% Local Variables:
% time-stamp-active: t 
% time-stamp-pattern: "5/\\filedate{%:y/%02m/%02d}$"
% End:
# end beamerthemeulille.sty

##############################################################################

# begin-ulille reportthemeulille.sty
\titlelogo{\includegraphics[width=3cm]{logo-univ-lille}}
# end reportthemeulille.sty

##############################################################################

# begin-ulille logo-univ-lille.pdf base64
# end+tmp
# end logo-univ-lille.pdf

##############################################################################
